<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dales Coach Route Builder</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- 3. Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Bus = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M8 6v6" /><path d="M15 6v6" /><path d="M2 12h19.6" /><path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3" /><circle cx="7" cy="18" r="2" /><path d="M9 18h5" /><circle cx="16" cy="18" r="2" /></svg>;
        const Search = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></svg>;
        const ExternalLink = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg>;
        const Copy = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg>;
        const AlertCircle = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>;
        const Loader2 = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>;
        const Move = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="5 9 2 12 5 15" /><polyline points="9 5 12 2 15 5" /><polyline points="19 9 22 12 19 15" /><polyline points="9 19 12 22 15 19" /><line x1="2" x2="22" y1="12" y2="12" /><line x1="12" x2="12" y1="2" y2="22" /></svg>;
        const Plus = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14" /><path d="M12 5v14" /></svg>;
        const Trash2 = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>;
        const GripVertical = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></svg>;
        const MapIcon = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21" /><line x1="9" x2="9" y1="3" y2="18" /><line x1="15" x2="15" y1="6" y2="21" /></svg>;
        const Wand2 = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m19 2 2 2-2 2-2-2 2-2Z"/><path d="m5 7 2 2-2 2-2-2 2-2Z"/><path d="m15 11 2 2-2 2-2-2 2-2Z"/><path d="M6 18H4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v1c0 .6-.4 1-1 1s-1-.4-1-1v-1c0-1.1-.9-2-2-2H6Z"/><path d="m19 12-7 7-3-3"/></svg>;
        const PenLine = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>;
        const Edit2 = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;

        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        // Helper to add seconds to a HH:MM string
        const addSecondsToTime = (timeStr, seconds) => {
            if (!timeStr) return '';
            const [h, m] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(h);
            date.setMinutes(m);
            date.setSeconds(0);
            date.setMilliseconds(0);
            
            // Add duration
            date.setSeconds(date.getSeconds() + seconds);
            
            // Format back to HH:MM
            const newH = String(date.getHours()).padStart(2, '0');
            const newM = String(date.getMinutes()).padStart(2, '0');
            return `${newH}:${newM}`;
        };

        function App() {
            const [address, setAddress] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [result, setResult] = useState(null);
            
            // New state for tracking address loading status
            const [isAddressLoading, setIsAddressLoading] = useState(false);
            
            // Route State
            const [route, setRoute] = useState([]);
            const [legsDurations, setLegsDurations] = useState([]); 
            
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerRef = useRef(null);

            // Overview Map Refs
            const overviewMapRef = useRef(null);
            const overviewMapInstanceRef = useRef(null);
            const overviewLayerGroupRef = useRef(null);

            // Drag and Drop State
            const [draggingIndex, setDraggingIndex] = useState(null);
            const [dragOverIndex, setDragOverIndex] = useState(null);
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);

            // 1. Initialize Map (Search)
            useEffect(() => {
                if (result && mapRef.current && !mapInstanceRef.current && window.L) {
                    const L = window.L;
                    try {
                        const map = L.map(mapRef.current).setView([parseFloat(result.lat), parseFloat(result.lon)], 18);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);
                        mapInstanceRef.current = map;
                        setTimeout(() => map.invalidateSize(), 100);
                    } catch (e) { console.error("Map init error:", e); }
                }
            }, [result]); 

            // 2. Update Marker (Search)
            useEffect(() => {
                if (result && mapInstanceRef.current && window.L) {
                    const L = window.L;
                    const map = mapInstanceRef.current;
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    map.setView([lat, lon], 18);

                    if (markerRef.current) markerRef.current.remove();

                    const marker = L.marker([lat, lon], { draggable: true }).addTo(map);
                    marker.bindPopup("<strong>New Stop</strong><br>Drag to adjust").openPopup();

                    marker.on('dragend', async (e) => {
                        const newPos = e.target.getLatLng();
                        
                        // Start loading state for address
                        setIsAddressLoading(true);
                        
                        setResult(prev => ({
                            ...prev,
                            lat: newPos.lat,
                            lon: newPos.lng,
                            w3wLink: `https://what3words.com/${newPos.lat.toFixed(6)},${newPos.lng.toFixed(6)}`,
                            displayName: "Updating address..."
                        }));

                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${newPos.lat}&lon=${newPos.lng}`);
                            const data = await response.json();
                            if (data && data.display_name) {
                                setResult(prev => ({ ...prev, displayName: data.display_name }));
                            } else {
                                setResult(prev => ({ ...prev, displayName: "Address not found for this spot" }));
                            }
                        } catch (err) {
                            setResult(prev => ({ ...prev, displayName: "Could not fetch new address" }));
                        } finally {
                            // End loading state
                            setIsAddressLoading(false);
                        }
                    });

                    markerRef.current = marker;
                    map.invalidateSize();
                }
            }, [result]); 

            // 3. ROUTING & TIMES LOGIC
            const routeCoordsString = useMemo(() => route.map(p => `${p.lat},${p.lon}`).join('|'), [route]);

            useEffect(() => {
                if (route.length < 2) {
                    if (overviewMapInstanceRef.current && overviewLayerGroupRef.current) {
                        updateOverviewMap([], route);
                    }
                    setLegsDurations([]);
                    return;
                }

                const fetchRouteData = async () => {
                    try {
                        const coordinates = route.map(p => `${p.lon},${p.lat}`).join(';');
                        const url = `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson`;
                        
                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.routes && data.routes.length > 0) {
                            const routeData = data.routes[0];
                            const routeCoords = routeData.geometry.coordinates.map(c => [c[1], c[0]]);
                            
                            updateOverviewMap(routeCoords, route);
                            const legs = routeData.legs.map(l => l.duration);
                            setLegsDurations(legs);
                        }
                    } catch (err) {
                        console.error("Routing failed", err);
                        const straightLines = route.map(p => [p.lat, p.lon]);
                        updateOverviewMap(straightLines, route, true);
                        setLegsDurations([]);
                    }
                };

                fetchRouteData();
            }, [routeCoordsString]);

            useEffect(() => {
                if (route.length === 0) return;

                setRoute(prevRoute => {
                    let routeChanged = false;
                    const newRoute = [...prevRoute];
                    
                    for (let i = 0; i < newRoute.length; i++) {
                        if (i === 0) continue; 

                        const prevPoint = newRoute[i-1];
                        const duration = legsDurations[i-1]; 

                        if (prevPoint.time && duration !== undefined) {
                            const calcTime = addSecondsToTime(prevPoint.time, duration);
                            if (!newRoute[i].isManual || !newRoute[i].time) {
                                if (newRoute[i].time !== calcTime) {
                                    newRoute[i].time = calcTime;
                                    newRoute[i].isManual = false; 
                                    routeChanged = true;
                                }
                            }
                        }
                    }
                    return routeChanged ? newRoute : prevRoute;
                });
            }, [legsDurations, route]); 


            const updateOverviewMap = (pathCoords, points, isFallback = false) => {
                if (!overviewMapRef.current || !window.L) return;
                const L = window.L;

                if (!overviewMapInstanceRef.current) {
                    const map = L.map(overviewMapRef.current);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                    overviewLayerGroupRef.current = L.featureGroup().addTo(map);
                    overviewMapInstanceRef.current = map;
                }

                const map = overviewMapInstanceRef.current;
                const layerGroup = overviewLayerGroupRef.current;
                layerGroup.clearLayers();

                if (pathCoords.length > 0) {
                    L.polyline(pathCoords, {
                        color: '#9333ea',
                        weight: 5,
                        opacity: 0.8,
                        dashArray: isFallback ? '10, 10' : null
                    }).addTo(layerGroup);
                }

                points.forEach((point, index) => {
                    L.marker([point.lat, point.lon])
                        .bindPopup(`<strong>Stop ${index + 1}</strong><br>${point.time || '--:--'}<br>${point.displayName}`)
                        .addTo(layerGroup);
                });

                try {
                    const bounds = layerGroup.getBounds();
                    if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));
                    else if (points.length > 0) map.setView([points[0].lat, points[0].lon], 15);
                    map.invalidateSize();
                } catch(e) {}
            };

            const performSearch = async (query) => {
                if (!query.trim()) return;
                setLoading(true);
                setError(null);
                if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; }

                try {
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=gb&limit=1`;
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.length === 0) { setError('Location not found.'); } 
                    else {
                        const loc = data[0];
                        setResult({
                            lat: loc.lat, lon: loc.lon, displayName: loc.display_name,
                            w3wLink: `https://what3words.com/${loc.lat},${loc.lon}`
                        });
                    }
                } catch (err) { setError('Failed to fetch location.'); } 
                finally { setLoading(false); }
            };

            const debouncedSearch = useRef(debounce(performSearch, 500)).current;
            useEffect(() => { if (address.length > 3) debouncedSearch(address); }, [address]);

            const copyToClipboard = (text) => {
                const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            };

            const addToRoute = () => {
                // Don't allow adding if updating
                if (!result || isAddressLoading) return;
                
                const newPoint = { 
                    ...result, 
                    time: route.length === 0 ? '09:00' : '', 
                    isManual: route.length === 0, 
                    id: Date.now() 
                };
                setRoute(prev => [...prev, newPoint]);
                setTimeout(() => {
                    const table = document.getElementById('route-table');
                    if(table) table.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            };

            const updateTime = (id, newTime) => {
                setRoute(prev => prev.map(point => 
                    point.id === id ? { ...point, time: newTime, isManual: true } : point
                ));
            };

            const updateName = (id, newName) => {
                setRoute(prev => prev.map(point => 
                    point.id === id ? { ...point, displayName: newName } : point
                ));
            };

            const removePoint = (id) => {
                setRoute(prev => prev.filter(point => point.id !== id));
            };

            // --- REORDER LOGIC ---
            const onDragStart = (e, index) => {
                dragItem.current = index;
                setDraggingIndex(index);
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/html", e.currentTarget.outerHTML);
                setTimeout(() => e.target.classList.add("opacity-40"), 0);
            };

            const onDragEnter = (e, index) => {
                e.preventDefault();
                if (dragOverIndex !== index) setDragOverIndex(index);
            };
            
            const onDragOver = (e) => e.preventDefault();

            const onDragEnd = (e) => {
                e.target.classList.remove("opacity-40");
                const copyList = [...route];
                if (dragItem.current !== null && dragOverIndex !== null && dragItem.current !== dragOverIndex) {
                    const item = copyList[dragItem.current];
                    copyList.splice(dragItem.current, 1);
                    copyList.splice(dragOverIndex, 0, item);
                    setRoute(copyList);
                }
                setDraggingIndex(null);
                setDragOverIndex(null);
                dragItem.current = null;
                dragOverItem.current = null;
            };

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900 pb-20">
                    <div className="max-w-4xl mx-auto space-y-6">
                        
                        <div className="text-center space-y-2">
                            <div className="inline-flex items-center justify-center p-4 bg-purple-700 rounded-full shadow-lg mb-2">
                                <Bus className="text-white w-8 h-8" />
                            </div>
                            <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight">Dales Coach Route Builder</h1>
                            <p className="text-slate-500">Plan your route with precise pickup points and auto-calculated times.</p>
                        </div>

                        <div className="bg-white rounded-2xl shadow-xl p-6 border border-slate-100">
                            <div className="relative">
                                <input type="text" value={address} onChange={(e) => setAddress(e.target.value)} placeholder="Search next stop location..." className="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all text-lg" />
                                <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-6 h-6" />
                                {loading && <div className="absolute right-4 top-1/2 -translate-y-1/2 text-purple-600"><Loader2 className="animate-spin w-6 h-6" /></div>}
                            </div>
                            {error && <div className="mt-4 p-4 bg-purple-50 text-purple-700 rounded-xl flex items-center gap-3 animate-in fade-in slide-in-from-top-2 border border-purple-100"><AlertCircle className="w-5 h-5 shrink-0" /><p>{error}</p></div>}
                        </div>

                        {result && (
                            <div className="grid md:grid-cols-2 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="bg-white rounded-2xl shadow-xl p-6 border border-slate-100 space-y-6 flex flex-col justify-between">
                                    <div className="space-y-6">
                                        <div>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Current Selection</h3>
                                            <div className="relative group">
                                                <textarea
                                                    value={result.displayName}
                                                    onChange={(e) => setResult(prev => ({ ...prev, displayName: e.target.value }))}
                                                    className="w-full text-sm text-slate-600 leading-relaxed font-medium bg-slate-50 border-transparent border-2 hover:border-purple-200 focus:border-purple-500 focus:bg-white rounded-lg p-2 transition-all outline-none resize-none overflow-hidden h-20"
                                                />
                                                <div className="absolute right-2 top-2 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity text-slate-400">
                                                    <Edit2 className="w-3 h-3" />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="p-3 bg-slate-50 rounded-xl border border-slate-100 relative group"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Latitude</h3><p className="font-mono text-sm font-semibold text-slate-800">{parseFloat(result.lat).toFixed(6)}</p></div>
                                            <div className="p-3 bg-slate-50 rounded-xl border border-slate-100 relative group"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Longitude</h3><p className="font-mono text-sm font-semibold text-slate-800">{parseFloat(result.lon).toFixed(6)}</p></div>
                                        </div>
                                        <div className="pt-4 border-t border-slate-100">
                                            <div className="flex justify-between items-end mb-2"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">What3Words</h3><button onClick={() => copyToClipboard(result.w3wLink)} className="flex items-center gap-1 text-xs text-purple-600 hover:text-purple-700 font-medium px-2 py-1 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors"><Copy className="w-3 h-3" /></button></div>
                                            <a href={result.w3wLink} target="_blank" rel="noreferrer" className="flex items-center justify-between w-full p-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl transition-all shadow-sm group border border-slate-200"><div className="flex items-center gap-2 overflow-hidden"><span className="font-black text-lg text-[#E11F26]">///</span><span className="text-xs opacity-75 truncate">{result.w3wLink.split('///')[1] || 'link'}</span></div><ExternalLink className="w-4 h-4 opacity-50" /></a>
                                        </div>
                                    </div>
                                    
                                    <button 
                                        onClick={addToRoute}
                                        disabled={isAddressLoading}
                                        className={`w-full py-4 mt-4 text-white rounded-xl shadow-lg font-bold text-lg flex items-center justify-center gap-2 transition-all active:scale-95 
                                            ${isAddressLoading 
                                                ? 'bg-slate-400 cursor-not-allowed opacity-75' 
                                                : 'bg-purple-600 hover:bg-purple-700'}`}
                                    >
                                        {isAddressLoading ? <Loader2 className="w-6 h-6 animate-spin" /> : <Plus className="w-6 h-6" />}
                                        {isAddressLoading ? 'Updating Address...' : 'Add to Route'}
                                    </button>
                                </div>
                                <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100 relative h-96 min-h-[384px]">
                                    <div ref={mapRef} className="absolute inset-0 w-full h-full z-0" style={{ minHeight: '100%' }}></div>
                                    <div className="absolute top-4 right-4 z-[1000] bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-medium text-slate-500 shadow-sm border border-slate-200 pointer-events-none flex items-center gap-1"><Move className="w-3 h-3" />Drag pin to adjust</div>
                                </div>
                            </div>
                        )}

                        {route.length > 0 && (
                            <div id="route-table" className="animate-in fade-in slide-in-from-bottom-8 duration-700 pt-8">
                                <div className="flex items-center justify-between mb-4 px-2">
                                    <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><span className="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm">{route.length} Stops</span>Current Route</h2>
                                </div>
                                
                                <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden mb-6">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left border-collapse">
                                            <thead>
                                                <tr className="bg-slate-50 border-b border-slate-200 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                    <th className="p-4 w-12"></th>
                                                    <th className="p-4 w-40">Time</th>
                                                    <th className="p-4">Location / Address</th>
                                                    <th className="p-4 hidden md:table-cell">Coordinates</th>
                                                    <th className="p-4 hidden sm:table-cell">W3W</th>
                                                    <th className="p-4 w-16">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {route.map((point, index) => {
                                                    const isDragOver = dragOverIndex === index && draggingIndex !== index;
                                                    const cellStyle = isDragOver ? {
                                                        boxShadow: draggingIndex < index ? "inset 0 4px 0 0 #9333ea" : "inset 0 -4px 0 0 #9333ea",
                                                        transition: "box-shadow 0.2s"
                                                    } : {};

                                                    return (
                                                        <tr 
                                                            key={point.id} 
                                                            draggable
                                                            onDragStart={(e) => onDragStart(e, index)}
                                                            onDragEnter={(e) => onDragEnter(e, index)}
                                                            onDragEnd={onDragEnd}
                                                            onDragOver={onDragOver}
                                                            className="hover:bg-purple-50/30 transition-colors cursor-default group"
                                                        >
                                                            <td className="p-4 align-middle text-slate-300 hover:text-purple-600 cursor-move" style={cellStyle}>
                                                                <GripVertical className="w-5 h-5 mx-auto" />
                                                            </td>
                                                            <td className="p-4 align-top" style={cellStyle}>
                                                                <div className="relative">
                                                                    <input 
                                                                        type="time" 
                                                                        value={point.time}
                                                                        onChange={(e) => updateTime(point.id, e.target.value)}
                                                                        className={`w-full p-2 pl-8 bg-white border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none text-sm font-bold ${point.isManual ? 'border-purple-200 text-purple-900' : 'border-slate-200 text-slate-600'}`}
                                                                    />
                                                                    <div className="absolute left-2.5 top-2.5 text-slate-400 pointer-events-none">
                                                                        {point.isManual ? <PenLine className="w-3 h-3 text-purple-500" /> : <Wand2 className="w-3 h-3" />}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td className="p-4 align-top" style={cellStyle}>
                                                                <div className="flex items-start gap-3">
                                                                    <div className="bg-purple-100 text-purple-700 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0 mt-0.5">{index + 1}</div>
                                                                    <div className="w-full">
                                                                        <textarea 
                                                                            value={point.displayName}
                                                                            onChange={(e) => updateName(point.id, e.target.value)}
                                                                            className="w-full text-sm font-medium text-slate-800 bg-transparent border-transparent border hover:border-purple-200 focus:border-purple-500 focus:bg-white rounded px-1 py-0.5 -ml-1 transition-all outline-none resize-none overflow-hidden"
                                                                            rows="2"
                                                                        />
                                                                        <p className="text-xs text-slate-400 mt-1 md:hidden">{parseFloat(point.lat).toFixed(5)}, {parseFloat(point.lon).toFixed(5)}</p>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td className="p-4 align-top hidden md:table-cell" style={cellStyle}>
                                                                <div className="text-xs font-mono text-slate-500 bg-slate-50 px-2 py-1 rounded border border-slate-100 inline-block">{parseFloat(point.lat).toFixed(5)}, {parseFloat(point.lon).toFixed(5)}</div>
                                                            </td>
                                                            <td className="p-4 align-top hidden sm:table-cell" style={cellStyle}>
                                                                <a href={point.w3wLink} target="_blank" className="text-xs text-purple-600 hover:text-purple-800 font-medium underline decoration-purple-200 hover:decoration-purple-800 underline-offset-2">Open Link</a>
                                                            </td>
                                                            <td className="p-4 align-top text-center" style={cellStyle}>
                                                                <button onClick={() => removePoint(point.id)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all" title="Remove Stop"><Trash2 className="w-4 h-4" /></button>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div className="bg-white rounded-2xl shadow-xl border border-slate-100 p-6 animate-in fade-in slide-in-from-bottom-8 duration-700 delay-100">
                                    <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><MapIcon className="w-6 h-6 text-purple-600" />Full Route Overview</h2>
                                    <div className="rounded-xl overflow-hidden border border-slate-200 h-96 relative"><div ref={overviewMapRef} className="absolute inset-0 w-full h-full z-0"></div></div>
                                </div>
                            </div>
                        )}
                        <div className="text-center text-slate-400 text-xs mt-8 pb-8"><p>Dales Coach Route Builder â€¢ Powered by OpenStreetMap</p></div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
